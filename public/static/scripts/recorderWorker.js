importScripts("libmp3lame.min.js");var recLength=0,recBuffersL=[],recBuffersR=[],sampleRate;this.onmessage=function(a){switch(a.data.command){case"init":init(a.data.config);break;case"record":record(a.data.buffer);break;case"exportWAV":exportWAV(a.data.type);break;case"getBuffer":getBuffer();break;case"clear":clear();break}};function init(a){sampleRate=a.sampleRate;console.log("sampleRate = "+sampleRate)}function record(a){recBuffersL.push(a[0]);recBuffersR.push(a[1]);recLength+=a[0].length}function exportWAV(c){var d=mergeBuffers(recBuffersL,recLength);var b=mergeBuffers(recBuffersR,recLength);var f=interleave(d,b);var a;if(c==="audio/raw"){a=encodeRAW(f)}else{a=encodeWAV(f)}var e=new Blob([a],{type:c});this.postMessage(e)}function getBuffer(){var b=[];b.push(mergeBuffers(recBuffersL,recLength));b.push(mergeBuffers(recBuffersR,recLength));console.log("begin mp3");var a=Lame.init();Lame.set_mode(a,Lame.JOINT_STEREO);Lame.set_num_channels(a,2);Lame.set_out_samplerate(a,44100);Lame.set_bitrate(a,128);Lame.init_params(a);var c=Lame.encode_buffer_ieee_float(a,b[0],b[1]);Lame.encode_flush(a);Lame.close(a);a=null;console.log("end mp3");var d=new Blob([new Uint8Array(c.data)],{type:"audio/mp3"});this.postMessage(d)}function clear(){recLength=0;recBuffersL=[];recBuffersR=[]}function mergeBuffers(d,b){var a=new Float32Array(b);var e=0;for(var c=0;c<d.length;c++){a.set(d[c],e);e+=d[c].length}return a}function interleave(f,b){var d=f.length+b.length;var a=new Float32Array(d);var c=0,e=0;while(c<d){a[c++]=f[e];a[c++]=b[e];e++}return a}function floatTo16BitPCM(b,e,a){for(var c=0;c<a.length;c++,e+=2){var d=Math.max(-1,Math.min(1,a[c]));b.setInt16(e,d<0?d*32768:d*32767,true)}}function writeString(a,d,b){for(var c=0;c<b.length;c++){a.setUint8(d+c,b.charCodeAt(c))}}function encodeWAV(c){var b=new ArrayBuffer(44+c.length*2);var a=new DataView(b);writeString(a,0,"RIFF");a.setUint32(4,32+c.length*2,true);writeString(a,8,"WAVE");writeString(a,12,"fmt ");a.setUint32(16,16,true);a.setUint16(20,1,true);a.setUint16(22,2,true);a.setUint32(24,sampleRate,true);a.setUint32(28,sampleRate*4,true);a.setUint16(32,4,true);a.setUint16(34,16,true);writeString(a,36,"data");a.setUint32(40,0,true);floatTo16BitPCM(a,44,c);return a}function encodeRAW(c){var b=new ArrayBuffer(c.length*2);var a=new DataView(b);floatTo16BitPCM(a,0,c);return a};