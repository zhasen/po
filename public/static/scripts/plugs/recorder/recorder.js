(function(b){b.URL=b.URL||b.webkitURL;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var a=function(h,f){f=f||{};f.sampleBits=f.sampleBits||16;f.sampleRate=f.sampleRate||(44100/6);var g=new (AudioContext||webkitAudioContext)();var e=g.createMediaStreamSource(h);g.createScriptProcessor=g.createScriptProcessor||g.createJavaScriptNode||g.createJavaScriptProcessor;var c=g.createScriptProcessor(4096,1,1);var d={size:0,buffer:[],inputSampleRate:g.sampleRate,inputSampleBits:16,outputSampleRate:f.sampleRate,oututSampleBits:f.sampleBits,input:function(i){this.buffer.push(new Float32Array(i));this.size+=i.length},compress:function(){var q=new Float32Array(this.size);var r=0;for(var o=0;o<this.buffer.length;o++){q.set(this.buffer[o],r);r+=this.buffer[o].length}var l=parseInt(this.inputSampleRate/this.outputSampleRate);var p=q.length/l;var k=new Float32Array(p);var n=0,m=0;while(n<p){k[n]=q[m];m+=l;n++}return k},encodeWAV:function(){var t=Math.min(this.inputSampleRate,this.outputSampleRate);var j=Math.min(this.inputSampleBits,this.oututSampleBits);var v=this.compress();var k=v.length*(j/8);var o=new ArrayBuffer(44+k);var q=new DataView(o);var m=1;var n=0;var r=function(w){for(var s=0;s<w.length;s++){q.setUint8(n+s,w.charCodeAt(s))}};r("RIFF");n+=4;q.setUint32(n,36+k,true);n+=4;r("WAVE");n+=4;r("fmt ");n+=4;q.setUint32(n,16,true);n+=4;q.setUint16(n,1,true);n+=2;q.setUint16(n,m,true);n+=2;q.setUint32(n,t,true);n+=4;q.setUint32(n,m*t*(j/8),true);n+=4;q.setUint16(n,m*(j/8),true);n+=2;q.setUint16(n,j,true);n+=2;r("data");n+=4;q.setUint32(n,k,true);n+=4;if(j===8){for(var p=0;p<v.length;p++,n++){var u=Math.max(-1,Math.min(1,v[p]));var l=u<0?u*32768:u*32767;l=parseInt(255/(65535/(l+32768)));q.setInt8(n,l,true)}}else{for(var p=0;p<v.length;p++,n+=2){var u=Math.max(-1,Math.min(1,v[p]));q.setInt16(n,u<0?u*32768:u*32767,true)}}return new Blob([q],{type:"audio/wav"})}};this.start=function(){e.connect(c);c.connect(g.destination)};this.stop=function(){c.disconnect();h.stop()};this.getBlob=function(){this.stop();return d.encodeWAV()};this.play=function(j){var i=this.getBlob();var k=b.URL.createObjectURL(i);j.src=k};this.upload=function(i,m,l){var j=new FormData();j.append("audioData",this.getBlob());var k=new XMLHttpRequest();if(l){k.addEventListener("progress",function(n){l("uploading",n)},false);k.addEventListener("load",function(n){l("ok",n)},false);k.addEventListener("error",function(n){l("error",n)},false);k.addEventListener("abort",function(n){l("cancel",n)},false)}k.open("POST",i);k.send(j)};c.onaudioprocess=function(j){var i=j.inputBuffer.getChannelData(0);if(f.onRecording){f.onRecording(i)}d.input(i)}};a.get=function(d,c){if(d){if(navigator.getUserMedia){navigator.getUserMedia({audio:true},function(f){var e=new a(f,c);d(e)},function(e){alert("拒绝设备访问，无法录音");d(null)})}else{alert("当前浏览器不支持录音功能。");return}}};b.Recorder=a})(window);