var testingDes;$(function(){testingDes=new Designer({target:$("#subject_designer"),status:"testing",imgPath:"download-get?keyUUID=",audioPath:"download-get?keyUUID=",audioImgPath:"download-get?keyUUID=",statusType:paperConfig.statusType});Testing.init()});var Testing={init:function(){$(window).bind("resize",function(){Testing.resizeView()});Testing.resizeView();Testing.loadPaper()},paper:null,testId:"",testResult:null,resizeView:function(){var a=$(window).height();var b=a-125;testingDes.config.pageHeight=b;$("#subject_designer").height(a);$("#subject_designer").find(".subject_page").height(b);$("#subject_designer").find(".designer_canvas").css("min-height",a-146)},loadPaper:function(){var b=$(".designer_loading");b.css({top:($(window).height()-b.outerHeight())/2,left:($(window).width()-b.outerWidth())/2});$.ajax({url:"test-get",type:"post",data:{method:"loadTestPaper",paperId:paperConfig.paperId,testId:paperConfig.testId,userId:paperConfig.userId,allotId:paperConfig.allotId,classCode:paperConfig.classCode,testFrom:paperConfig.testFrom},dataType:"json",success:function(c){if(c.errno){alert("数据加载失败！")}else{a(c)}},error:function(){if(defaultDef){a(defaultDef)}else{alert("数据加载失败！")}}});function a(c){Testing.paper=c.result;Testing.testId=Testing.paper.testId;if(Testing.paper.allTestResultDetail&&Testing.paper.allTestResultDetail.length>0){Testing.testResult=Testing.paper.allTestResultDetail}$("#paper_name").text(Testing.paper.paperName);Player.structItem=Testing.paper.structItem.trees;Player.init();console.log("开始测试，testId："+Testing.testId);if(testingDes.config.statusType=="review"){Review.init("start")}b.remove();$(".designer_box").show()}}};var Player={init:function(){this.bindButtons();this.buildItems();var b=null;if(Testing.testResult){var d={};for(var h=0;h<Testing.testResult.length;h++){var l=Testing.testResult[h];Player.paperAnswers[l.subjectId]=JSON.parse(l.answerContent);Player.paperDatas[l.subjectId]=JSON.parse(l.subjectData);if(l.subjectExtend){d[l.subjectId]=JSON.parse(l.subjectExtend)}}if(testingDes.config.statusType=="normal"){for(var h=this.parts.length-1;h>=0;h--){var f=this.parts[h];var j=false;for(var c=f.items.length-1;c>=0;c--){var k=f.items[c];var a=k.subjectList.id;if(d[a]){j=true;var e=d[a];this.partIndex=e.partIndex;this.itemIndex=e.itemIndex;this.pageIndex=e.pageIndex;var g=Player.paperDatas[a];if(g.times&&g.times.length>0){b=g.times[0]}break}}if(j){break}}}}this.buildAnswer();Player.play(b)},bindButtons:function(){$("#btn_back").unbind().bind("click",function(){Player.back()});$("#btn_next").unbind().bind("click",function(){Player.next()});$("#btn_continue").unbind().bind("click",function(){Player.next()});$("#btn_ok").unbind().bind("click",function(){$("#btn_next").prop("disabled","")});$("#btn_timer").unbind().bind("click",function(){if($("#header_timer").is(":visible")){$("#header_timer").hide();$("#btn_timer").val("SHOW TIMER")}else{$("#header_timer").show();$("#btn_timer").val("HIDE TIMER")}});$("#btn_review").unbind().bind("click",function(){if(testingDes.config.statusType=="normal"){Review.showTestReview()}else{Review.show()}});$("#btn_exit").unbind().bind("click",function(){if(confirm("确定要退出吗？")){window.opener=null;window.open("","_self");window.close()}})},structItem:null,parts:[],partIndex:0,partStatus:{itemIndex:0,pageIndex:0},items:[],itemIndex:0,subjectList:null,pageIndex:0,paperAnswers:{},paperDatas:{},answers:[],pageAnswer:[],questionList:[],questionIndex:0,play:function(E){if(this.itemIndex>this.partStatus.itemIndex){this.partStatus.itemIndex=this.itemIndex;this.partStatus.pageIndex=0}else{if(this.itemIndex==this.partStatus.itemIndex){if(this.pageIndex>this.partStatus.pageIndex){this.partStatus.pageIndex=this.pageIndex}}}var w=this.parts[this.partIndex];this.items=w.items;var C=this.items[this.itemIndex];$("#part_name").text("[ "+w.displayName+" ]");this.subjectList=C.subjectList;var g=this.subjectList.pages[this.pageIndex];var y=this.answers[this.itemIndex];this.pageAnswer=y[this.pageIndex];testingDes.open(g);Testing.resizeView();if(g.url){$("#bgaudio_player").attr("src",testingDes.config.audioPath+g.url)}else{$("#bgaudio_player").attr("src","")}$("#header_right_normal").find(".testbtn").hide();if(g.extralData){$("#btn_extral").show().unbind().bind("click",function(){testingDes.open(g.extralData);Testing.resizeView();$(".designer_header_right").hide();$("#header_right_extral_return").show()});$("#btn_extral_return").unbind().bind("click",function(){testingDes.open(g);Testing.resizeView();$(".designer_header_right").hide();$("#header_right_normal").show()})}else{$("#btn_extral").hide()}$(".designer_header_right").hide();$("#header_right_normal").show();$("#btn_next").val("NEXT");if(testingDes.config.statusType=="review"){$("#btn_next").show();$("#btn_back").show();$("#btn_review").show();var v=this.getBack();if(v==null){$("#btn_back").prop("disabled","disabled")}else{$("#btn_back").prop("disabled","")}var u=this.getNext();if(u==null){$("#btn_next").prop("disabled","disabled")}else{$("#btn_next").prop("disabled","")}}else{if(g.slidingType=="normal_mode"){if(g.isExplain=="true"){$("#btn_continue").show().prop("disabled","")}else{$("#btn_next").show();$("#btn_back").show();var v=this.getBack();if(v==null){$("#btn_back").prop("disabled","disabled")}else{$("#btn_back").prop("disabled","")}var u=this.getNext();if(u==null){$("#btn_next").val("SUBMIT")}}}else{if(g.slidingType=="complete_mode"){$("#btn_continue").show().prop("disabled","disabled");if(g.isExplain=="true"){var B=0;for(var D=0;D<g.containers.length;D++){var o=g.containers[D];if(o.contents){for(var z=0;z<o.contents.length;z++){var l=o.contents[z];if(l.className=="org.neworiental.rmp.base::BaseTLFText"){B++}}}}if(B==1){$(".subject_page").bind("scroll",function(){var i=$(this).scrollTop();$(this).scrollTop(999999);if(i==$(this).scrollTop()){$("#btn_continue").prop("disabled","")}$(this).scrollTop(i)})}}}else{if(g.slidingType=="auto_mode"){$("#btn_continue").show().prop("disabled","");var A=$(".subject_box[n='org.neworiental.rmp.base::ToelfAudio']");if(A.length>0){var x=A.find("audio");x.bind("ended",function(){Player.next()})}var F=$(".subject_box[n='org.neworiental.rmp.base::TOEFLTimerViewer']");if(F.length>0){var n=F.find(".subject_canvas");n.bind("ended",function(){Player.next()})}var c=$(".subject_box[n='org.neworiental.rmp.base::TOEFLRecord']");if(c.length>0){var b=c.find(".subject_canvas");b.bind("ended",function(){Player.next()})}var u=this.getNext();if(u==null){$("#btn_continue").val("SUBMIT")}}else{if(g.slidingType=="custom_mode"){$("#btn_next").show().prop("disabled","disabled");$("#btn_ok").show().prop("disabled","disabled");var d=$(".subject_box[n='org.neworiental.rmp.base::OptionGroup']");if(d.length>0){d.find("input").bind("click",function(){$("#btn_ok").prop("disabled","")})}var m=$(".subject_box[n='org.neworiental.rmp.base::TOEFLTable']");if(m.length>0){m.find(".tableselect_chkbox").bind("click",function(){$("#btn_ok").prop("disabled","")})}}}}}}if(testingDes.config.statusType=="review"){$("#header_question").children("span").text((this.questionIndex+1)+" of "+this.questionList.length)}else{if(C.item.subjectType=="TOEFL_READ"){var t=[];for(var f=0;f<this.items.length;f++){var q=this.items[f];var a=q.subjectList;for(var e=0;e<a.pages.length;e++){var r=a.pages[e];if(r.isExplain=="false"){t.push(r.ID)}}}if(g.isExplain=="true"){$("#header_question").hide()}else{$("#header_question").show();var k=t.indexOf(g.ID)+1;$("#header_question").children("span").text(k+" of "+t.length)}if(g.isExplain=="false"){$("#btn_review").show()}}else{$("#header_question").show();$("#header_question").children("span").text((this.itemIndex+1)+" of "+w.items.length)}}if(testingDes.config.statusType!="review"){var j=w.relation;if(j&&j.examTime){if(this.timer==null||this.timer.relation.id!=j.id){this.stopTimer();var h=j.examTime*60;if(typeof E!="undefined"&&E!=null){h=E}this.initTimer(j,h)}}else{this.stopTimer()}if(this.timer!=null){if(g.isExplain=="false"||(this.items[this.itemIndex].item.subjectType=="TOEFL_READ"&&g.slidingType=="complete_mode")){this.activeTimer()}else{this.pauseTimer()}}if(g.time!=""&&g.time!="0"&&parseInt(g.time)){var s=parseInt(g.time);this.initPageTimer(s);this.activeTimer()}else{this.stopPageTimer()}}},getNext:function(){var k={partIndex:this.partIndex,itemIndex:this.itemIndex,pageIndex:this.pageIndex};if(testingDes.config.statusType=="review"){if(this.questionIndex<this.questionList.length-1){var f=this.questionList[this.questionIndex+1];k.partIndex=f.partIndex;k.itemIndex=f.itemIndex;k.pageIndex=f.pageIndex}else{return null}}else{if(this.itemIndex<this.partStatus.itemIndex||this.pageIndex<this.partStatus.pageIndex){var a=this.parts[this.partIndex];for(var d=this.itemIndex;d<=this.partStatus.itemIndex;d++){var h=a.items[d];var b=h.subjectList;var g=this.pageIndex+1;if(d!=this.itemIndex){g=0}for(var c=g;c<b.pages.length;c++){var e=b.pages[c];if(e.isExplain=="false"){k.itemIndex=d;k.pageIndex=c;return k}}}}else{if(this.pageIndex<this.subjectList.pages.length-1){k.pageIndex++}else{if(this.itemIndex<this.items.length-1){k.itemIndex++;k.pageIndex=0}else{if(this.partIndex<this.parts.length-1){k.partIndex++;k.itemIndex=0;k.pageIndex=0}else{k=null}}}}}return k},next:function(a){if(typeof a=="undefined"){a=true}var b=false;if(this.timer&&this.timer.pageTime&&this.timer.pageTime>0){b=true}var d=this.getNext();var f=false;if(testingDes.config.statusType=="review"){if(d!=null){this.questionIndex++;if(d.partIndex!=this.partIndex){f=true}this.partIndex=d.partIndex;this.itemIndex=d.itemIndex;this.pageIndex=d.pageIndex;if(f){this.buildAnswer()}this.play()}}else{if(d==null){if(a){var c="确认提交试卷？";if(b){c="还有剩余时间，"+c}if(confirm(c)){this.submit()}}else{this.submit()}}else{var e=true;if(d.partIndex!=this.partIndex){var c="确定离开当前题型，进入下一阶段？";if(b){c="还有剩余时间，"+c}e=confirm(c);if(e){this.partStatus={itemIndex:0,pageIndex:0};f=true}}else{if(b){e=confirm("还有剩余时间，确定进入下一步？")}}if(e){this.sendAnswer(d);this.partIndex=d.partIndex;this.itemIndex=d.itemIndex;this.pageIndex=d.pageIndex;if(f){this.buildAnswer()}this.play()}}}},getBack:function(){if(testingDes.config.statusType=="review"){var k={pageIndex:this.pageIndex,itemIndex:this.itemIndex};if(this.questionIndex>0){var f=this.questionList[this.questionIndex-1];k.partIndex=f.partIndex;k.itemIndex=f.itemIndex;k.pageIndex=f.pageIndex}else{k=null}return k}else{var a=this.parts[this.partIndex];for(var d=this.itemIndex;d>=0;d--){var h=a.items[d];var b=h.subjectList;var g=this.pageIndex-1;if(d!=this.itemIndex){g=b.pages.length-1}for(var c=g;c>=0;c--){var e=b.pages[c];if(e.isExplain=="false"){return{itemIndex:d,pageIndex:c}}}}}return null},back:function(){var a=this.getBack();if(a!=null){if(testingDes.config.statusType=="review"){this.questionIndex--;var b=false;if(this.partIndex!=a.partIndex){b=true}this.partIndex=a.partIndex;this.itemIndex=a.itemIndex;this.pageIndex=a.pageIndex;if(b){this.buildAnswer()}this.play()}else{this.sendAnswer({partIndex:this.partIndex,itemIndex:a.itemIndex,pageIndex:a.pageIndex});this.itemIndex=a.itemIndex;this.pageIndex=a.pageIndex;this.play()}}},buildAnswer:function(){this.answers=[];var b=this.parts[this.partIndex];for(var g=0;g<b.items.length;g++){var k=b.items[g];var a=k.subjectList.id;if(this.paperAnswers[a]){this.answers.push(this.paperAnswers[a])}else{var d=k.subjectList;var c=d.pages;var e=[];for(var h=0;h<c.length;h++){var j=c[h];var f=this.getPageAnswer(d,h);e.push(f)}this.answers.push(e)}}},sendAnswer:function(k){var b=this.itemIndex;var e=this.pageIndex;var l=this.items[b];var h=this.answers[this.itemIndex];var i=this.getPageAnswer(this.subjectList,this.pageIndex);h[this.pageIndex]=i;var d=JSON.stringify(h);this.paperAnswers[this.subjectList.id]=h;var c=this.buildSubjectData(h);var a=c.data.totalMark;var f=JSON.stringify(c);this.paperDatas[this.subjectList.id]=c;var g={testId:Testing.testId,testFrom:"tpo",subjectId:this.subjectList.id,subjectIndex:b,subjectData:f,examPoint:"",answerContent:d,pageIndex:e,leftTimes:"[]",isSubmit:0,extend:"",subjectExtend:JSON.stringify(k),subjectMark:a,usedTime:0};$.ajax({url:"test-save",type:"post",data:{method:"saveTestResultDetail",data:g}});var j=$(".subject_box[n='org.neworiental.rmp.base::TOEFLRecord']");if(j.length>0){j.trigger("submit")}},getPageAnswer:function(q,o){var e=q.pages[o];var j=[];for(var k=0;k<e.containers.length;k++){var m=e.containers[k];if(m.contents&&m.contents.length>0){for(var t=0;t<m.contents.length;t++){var l=m.contents[t];if(l.className=="org.neworiental.rmp.base::OptionGroup"){var b=[l.className];var h=$("#"+l.ID);if(h.length>0){h.find("input[name=subject_select_radio]:checked").each(function(){var i=parseInt($(this).attr("ind"));b.push(i)})}j.push(b)}else{if(l.className=="org.neworiental.rmp.base::ToelfInsertPart"){var b=[l.className];var p=-1;var h=$("#"+l.ID);if(h.length>0){var d=h.find(".inserted");if(d.length>0){p=parseInt(d.attr("ind"))}}b.push(p);j.push(b)}else{if(l.className=="org.neworiental.rmp.base::TOEFLReadingDrag"){var b=[l.className];if(l.answer){b=b.concat(l.answer)}else{var s=l.blankNum.split("*^*");for(var r=0;r<s.length;r++){var f=parseInt(s[r]);var c=0;while(c<f){b.push(-1);c++}}}j.push(b)}else{if(l.className=="org.neworiental.rmp.base::TOEFLRecord"){var b=[l.className,""];var h=$("#"+l.ID);if(h.length>0){var a=h.attr("recordId");if(a){b[1]=a}}j.push(b)}else{if(l.className=="org.neworiental.rmp.base::BaseInputText"){var b=[l.className];var p="";var h=$("#"+l.ID);if(h.length>0){var n=h.find("textarea");p=n.val()}b.push(p);j.push(b)}else{if(l.className=="org.neworiental.rmp.base::TOEFLTable"){var b=[l.className];var p="";var h=$("#"+l.ID);if(h.length>0){var g=h.find("tr:not(.table_select_header)");g.each(function(){var u=-1;var i=$(this).children(".table_checked");if(i.length){u=parseInt(i.attr("ind"))}b.push(u)})}j.push(b)}}}}}}}}}return j},buildSubjectData:function(f){var j={gradeInfo:"[]",maxIndex:0,index:0,id:this.subjectList.id,times:[]};var c=this.subjectList.pages;for(var e=0;e<=this.pageIndex;e++){var h=c[e];if(h.isExplain=="false"){j.index++}}j.maxIndex=this.pageIndex+1;if(j.maxIndex>c.length-1){j.maxIndex=c.length-1}if(this.timer!=null){j.times=[this.timer.time]}var d={id:this.subjectList.id,testPoint:null,subjectMark:0,totalMark:0,answerContent:f};j.data=d;var b=[];d.data=b;for(var e=0;e<c.length;e++){var h=c[e];var g=f[e];var a=this.getPageData(h,d,g);b.push(a)}return j},getPageData:function(k,f,g){var b={ID:k.ID,data:[]};for(var q=0;q<k.containers.length;q++){var a=k.containers[q];if(a.contents&&a.contents.length>0){for(var l=0;l<a.contents.length;l++){var p=a.contents[l];if(p.className=="org.neworiental.rmp.base::OptionGroup"){var j=this.getSubjectAnswer(g,k,p);var o={ID:p.ID,optionCount:p.options.length,isResponse:true,type:p.className,data:"",subjectiveItem:p.subjectiveItem=="false"?false:true,testPointID:[p.testPointID],testPointName:[p.testPointName],rightAnswer:JSON.parse(p.rightAns),userAnswer:j,userMark:[0],sourceMark:[parseInt(p.sourceMark)]};if(j.length<=1){o.isResponse=false}else{var m=true;if(j.length-1!=o.rightAnswer.length){m=false}else{for(var e=1;e<j.length;e++){if(j[e]!=o.rightAnswer[e-1]){m=false;break}}}if(m){o.userMark=o.sourceMark}}b.data.push(o);var n=parseInt(p.sourceMark);if(n){f.totalMark+=n}}else{if(p.className=="org.neworiental.rmp.base::ToelfInsertPart"){var j=this.getSubjectAnswer(g,k,p);var o={ID:p.ID,isResponse:true,type:p.className,data:"",subjectiveItem:p.subjectiveItem=="false"?false:true,testPointID:[p.testPointID],testPointName:[p.testPointName],rightAnswer:JSON.parse(p.rightAns),userAnswer:j,userMark:[0],sourceMark:[parseInt(p.sourceMark)]};if(j.length<=1||j[1]==-1){o.isResponse=false}else{if(o.rightAnswer.length>0){if(j[1]==o.rightAnswer[0]){o.userMark=o.sourceMark}}}b.data.push(o);var n=parseInt(p.sourceMark);if(n){f.totalMark+=n}}else{if(p.className=="org.neworiental.rmp.base::TOEFLReadingDrag"){var j=this.getSubjectAnswer(g,k,p);var o={ID:p.ID,isResponse:false,type:p.className,data:"",subjectiveItem:p.subjectiveItem=="false"?false:true,testPointID:[p.testPointID],testPointName:[p.testPointName],rightAnswer:JSON.parse(p.rightAns),userAnswer:j,userMark:[0],sourceMark:[parseInt(p.sourceMark)]};for(var e=1;e<j.length;e++){if(j[e]!=-1){o.isResponse=true;break}}if(o.isResponse){var d=0;var h=o.rightAnswer.length;for(var e=1;e<j.length;e++){if(j[e]!=-1&&j[e]==o.rightAnswer[e-1]){d++}}var c=p.blankNum.split("*^*");if(c.length>1){if(d>=h-1){o.userMark=[2]}else{if(d==h-2){o.userMark=[1]}}}else{if(d==h){o.userMark=o.sourceMark}else{if(d>=Math.ceil(h/2)){o.userMark=[parseInt(p.sourceMark)/2]}}}}b.data.push(o);var n=parseInt(p.sourceMark);if(n){f.totalMark+=n}}else{if(p.className=="org.neworiental.rmp.base::BaseInputText"){var j=this.getSubjectAnswer(g,k,p);var o={ID:p.ID,isResponse:false,type:p.className,data:"",subjectiveItem:p.subjectiveItem=="false"?false:true,testPointID:[p.testPointID],testPointName:[p.testPointName],rightAnswer:JSON.parse(p.rightAns),userAnswer:j,userMark:[0],sourceMark:[parseInt(p.sourceMark)]};if(j[1]!=""){o.isResponse=true}b.data.push(o);var n=parseInt(p.sourceMark);if(n){f.totalMark+=n}}else{if(p.className=="org.neworiental.rmp.base::TOEFLRecord"){var j=this.getSubjectAnswer(g,k,p);var o={ID:p.ID,isResponse:true,type:p.className,data:"",subjectiveItem:p.subjectiveItem=="false"?false:true,testPointID:[p.testPointID],testPointName:[p.testPointName],rightAnswer:JSON.parse(p.rightAns),userAnswer:j,userMark:[0],sourceMark:[parseInt(p.sourceMark)]};b.data.push(o);var n=parseInt(p.sourceMark);if(n){f.totalMark+=n}}else{if(p.className=="org.neworiental.rmp.base::TOEFLTable"){var j=this.getSubjectAnswer(g,k,p);var o={ID:p.ID,isResponse:true,type:p.className,data:"",subjectiveItem:p.subjectiveItem=="false"?false:true,testPointID:[p.testPointID],testPointName:[p.testPointName],rightAnswer:JSON.parse(p.rightAns),userAnswer:j,userMark:[0],sourceMark:[parseInt(p.sourceMark)]};for(var e=1;e<j.length;e++){if(j[e]!=-1){o.isResponse=true;break}}if(o.isResponse){var m=true;for(var e=1;e<j.length;e++){if(j[e]==-1||j[e]!=o.rightAnswer[e-1]){m=false;break}}if(m){o.userMark=o.sourceMark}}b.data.push(o);var n=parseInt(p.sourceMark);if(n){f.totalMark+=n}}}}}}}}}}return b},getSubjectAnswer:function(d,g,h){var e=[];for(var c=0;c<d.length;c++){var b=d[c];if(b[0]==h.className){e.push(b)}}var j=-1;for(var l=0;l<g.containers.length;l++){var a=g.containers[l];if(a.contents&&a.contents.length>0){for(var f=0;f<a.contents.length;f++){var k=a.contents[f];if(k.className==h.className){j++}if(k.ID==h.ID){return e[j]}}}}return null},submit:function(){var g={testId:Testing.testId,testFrom:"tpo",subjectIndex:0,pageIndex:0,leftTimes:"[]",isSubmit:1,totalMark:0,totalUseTime:0,extend:"",subjects:[]};var d=this.answers[this.itemIndex];var c=this.getPageAnswer(this.subjectList,this.pageIndex);d[this.pageIndex]=c;this.paperAnswers[this.subjectList.id]=d;var e=this.buildSubjectData(d);this.paperDatas[this.subjectList.id]=e;for(var f in this.paperAnswers){var b=this.paperAnswers[f];var e=this.paperDatas[f];var a={subjectId:f,subjectData:JSON.stringify(e),answerContent:JSON.stringify(b),subjectMark:e.data.totalMark,examPoint:null,usedTime:0,subjectExtend:""};g.subjects.push(a)}$("#header_right_normal").find("input").unbind();this.stopTimer();$.ajax({url:"test-save",type:"post",data:{method:"finishTest",data:g},success:function(){alert("提交成功!");testingDes.config.statusType="review";Review.init("end");Player.bindButtons()}})},timer:null,initTimer:function(a,b){$("#header_timer").show();$("#btn_timer").val("HIDE TIMER");this.timer={};this.timer.relation=a;this.timer.time=b;this.timer.interval=null},initPageTimer:function(a){if(this.timer==null){this.timer={};this.timer.relation=null;this.timer.time=null;this.timer.interval=null}this.timer.pageTime=a},activeTimer:function(){var a=new Date().getTime();if(this.timer.interval!=null){return}function b(){var h;if(Player.timer.pageTime){h=Player.timer.pageTime}else{h=Player.timer.time}if(h<0){h=0}var c=Math.floor(h/3600);if(c<10){c="0"+c}var f=Math.floor((h-c*3600)/60);if(f<10){f="0"+f}var j=h%60;if(j<10){j="0"+j}$("#header_timer").text(c+" : "+f+" : "+j);if(Player.timer.time!=null&&Player.timer.time<=0){clearInterval(Player.timer.interval);alert("倒计时已到！");var d=Player.parts[Player.partIndex];for(var e=Player.itemIndex;e<d.items.length;e++){if(Player.itemIndex!=e){Player.pageIndex=0}Player.itemIndex=e;var g=Player.items[Player.itemIndex];Player.subjectList=g.subjectList;Player.sendAnswer({partIndex:Player.partIndex+1,itemIndex:0,pageIndex:0})}Player.partIndex++;Player.itemIndex=0;Player.pageIndex=0;Player.play()}else{if(Player.timer.pageTime!=null&&Player.timer.pageTime<=0){clearInterval(Player.timer.interval);alert("倒计时已到！");Player.next(false)}}}this.timer.interval=setInterval(function(){var c=new Date().getTime();var d=c-a;var e=Math.floor(d/1000);if(e==0){return}a=c;if(Player.timer.time){Player.timer.time-=e}if(Player.timer.pageTime){Player.timer.pageTime-=e}b()},250);b();$("#header_timer_box").show()},pauseTimer:function(){if(this.timer!=null){clearInterval(this.timer.interval);this.timer.interval=null}$("#header_timer_box").hide()},stopTimer:function(){this.pauseTimer();this.timer=null},stopPageTimer:function(){if(this.timer!=null){if(this.timer.time!=null){this.timer.pageTime=null}else{this.stopTimer()}}},buildItems:function(){function c(k,g){if(k.items&&k.items.length>0){var j;if(k.relation){j=k.relation}else{if(g&&g.relation){j=g.relation}}if(j){k.relation=j}if(g){k.displayName=g.name+"/"+k.name}else{k.displayName=k.name}Player.parts.push(k);for(var d=0;d<k.items.length;d++){var h=k.items[d];var f=h.item.subjectData;f=decodeURIComponent(f);var e=JSON.parse(f);h.subjectList=e}}else{if(k.trees&&k.trees.length>0){for(var d=0;d<k.trees.length;d++){var l=k.trees[d];c(l,k)}}}}this.parts=[];for(var b=0;b<this.structItem.length;b++){var a=this.structItem[b];c(a)}},containsSubject:function(e){for(var c=0;c<e.containers.length;c++){var b=e.containers[c];if(b.contents&&b.contents.length>0){for(var a=0;a<b.contents.length;a++){var d=b.contents[a];if(d.className=="org.neworiental.rmp.base::OptionGroup"){return true}else{if(d.className=="org.neworiental.rmp.base::ToelfInsertPart"){return true}else{if(d.className=="org.neworiental.rmp.base::TOEFLReadingDrag"){return true}else{if(d.className=="org.neworiental.rmp.base::BaseInputText"){return true}else{if(d.className=="org.neworiental.rmp.base::TOEFLRecord"){return true}else{if(d.className=="org.neworiental.rmp.base::TOEFLTable"){return true}}}}}}}}}return false}};var Review={init:function(n){Player.questionList=[];var o=[];for(var i=0;i<Player.parts.length;i++){var c=Player.parts[i];var j={displayName:c.displayName,name:c.name,correctCount:0,subjectCount:0,userMark:0,totalMark:0,subjects:[]};for(var b=0;b<c.items.length;b++){var m=c.items[b];var d=m.subjectList;var e=Player.paperAnswers[d.id];for(var g=0;g<d.pages.length;g++){var k=d.pages[g];var f=null;if(e&&e[g]){f=e[g]}var l=this.getPageSubjectInfo(k,f);if(l!=null){var a={partIndex:i,itemIndex:b,pageIndex:g,des:l.des,rightAns:l.rightAns,userAns:l.userAns,questionIndex:Player.questionList.length,answerStatus:l.answerStatus};Player.questionList.push(a);j.subjectCount++;j.totalMark+=l.mark;j.userMark+=l.userMark;j.subjects.push(a);if(l.right){j.correctCount++}}}}o.push(j)}if(n=="start"){Player.questionIndex=0}else{Player.questionIndex=Player.questionList.length-1}var h=Player.questionList[Player.questionIndex];Player.partIndex=h.partIndex;Player.itemIndex=h.itemIndex;Player.pageIndex=h.pageIndex;Player.play();this.buildList(o)},buildList:function(b){var g=$("#review_content").empty();for(var e=0;e<b.length;e++){var a=b[e];g.append("<div class='review_title'>"+a.displayName+"</div>");if(a.name!="Speaking"&&a.name!="Writing"){g.append("<div class='review_statis'>正确数/题目数：<span>"+a.correctCount+" / "+a.subjectCount+"</span>得分/总分：<span>"+a.userMark+" / "+a.totalMark+"</span></div>")}var d=$("<ul class='review_grid'></ul>").appendTo(g);d.append("<li class='hd'><div class='review_no'>NO.</div><div class='review_des'>Description</div><div class='review_uanswer'>Your Answer</div><div class='review_canswer'>Correct Answer</div><div class='review_status'>Status</div><div class='review_correct'></div></li>");for(var c=0;c<a.subjects.length;c++){var f=a.subjects[c];var h=$("<li class='item'><div class='review_no'>"+(c+1)+"</div><div class='review_des'>"+f.des+"</div><div class='review_uanswer'>"+f.userAns+"</div><div class='review_canswer'>"+f.rightAns+"</div><div class='review_status'>"+f.answerStatus+"</div><div class='review_correct'><span class='tpbtn'>未批改</span></div></li>");h.appendTo(d);if(c%2!=0){h.addClass("dif")}h.attr({partIndex:f.partIndex,itemIndex:f.itemIndex,pageIndex:f.pageIndex,questionIndex:f.questionIndex});h.bind("click",function(){$("#review_content").find(".review_selected").removeClass("review_selected");$(this).addClass("review_selected");var i=Player.partIndex;Player.partIndex=parseInt($(this).attr("partIndex"));Player.itemIndex=parseInt($(this).attr("itemIndex"));Player.pageIndex=parseInt($(this).attr("pageIndex"));Player.questionIndex=parseInt($(this).attr("questionIndex"));if(Player.partIndex!=i){Player.buildAnswer()}Player.play()})}}},show:function(){$("#dlg_paper_review").dlg()},getPageSubjectInfo:function(b,e){var s=false;var f={des:"",mark:0,rightAns:"",userAns:"",userMark:0,right:false,answerStatus:""};for(var g=0;g<b.containers.length;g++){var j=b.containers[g];if(j.contents&&j.contents.length>0){for(var r=0;r<j.contents.length;r++){var h=j.contents[r];if(h.className=="org.neworiental.rmp.base::BaseRichTxt"){f.des+=testingDes.utils.toText(h.htmlText)+"&nbsp;&nbsp;"}else{if(h.className=="org.neworiental.rmp.base::BaseTLFText"){f.des+=testingDes.utils.toText(decodeURIComponent(h.text))+"&nbsp;&nbsp;"}else{if(h.className=="org.neworiental.rmp.base::OptionGroup"){s=true;var p=JSON.parse(h.rightAns);var d=null;if(e){d=Player.getSubjectAnswer(e,b,h)}var k=["A","B","C","D","E","F"];if(p&&p.length>0){for(var n=0;n<p.length;n++){if(n!=0){f.rightAns+=","}var a=p[n];f.rightAns+=k[a]}}if(d&&d.length>1){for(var n=1;n<d.length;n++){if(n!=1){f.userAns+=","}var a=d[n];f.userAns+=k[a]}}var q=false;if(p&&d&&d.length>1){if(d.length-1==p.length){q=true;for(var m=1;m<d.length;m++){if(d[m]!=p[m-1]){q=false;break}}}}f.right=q;if(h.sourceMark){f.mark=parseInt(h.sourceMark);if(q){f.userMark=f.mark}}if(q){f.answerStatus="correct"}else{f.answerStatus="incorrect"}}else{if(h.className=="org.neworiental.rmp.base::ToelfInsertPart"){s=true;var p=JSON.parse(h.rightAns);var d=null;if(e){d=Player.getSubjectAnswer(e,b,h)}if(p&&p.length>0){f.rightAns="第"+(p[0]+1)+"空"}if(d&&d.length>1&&d[1]!=-1){f.userAns="第"+(d[1]+1)+"空"}var q=false;if(p&&p.length>0&&d&&d.length>1){if(d[1]!=-1&&d[1]==p[0]){q=true}}f.right=q;if(h.sourceMark){f.mark=parseInt(h.sourceMark);if(q){f.userMark=f.mark}}if(q){f.answerStatus="correct"}else{f.answerStatus="incorrect"}}else{if(h.className=="org.neworiental.rmp.base::TOEFLReadingDrag"){s=true;var p=JSON.parse(h.rightAns);var d=null;if(e){d=Player.getSubjectAnswer(e,b,h)}if(p&&p.length>0){for(var n=0;n<p.length;n++){if(n!=0){f.rightAns+=","}var a=p[n];f.rightAns+="第"+(a+1)+"空"}}if(d&&d.length>1){for(var m=1;m<d.length;m++){if(d[m]!=-1){if(f.userAns!=""){f.userAns+=","}var a=d[m];f.userAns+="第"+(a+1)+"空"}}}if(h.sourceMark){f.mark=parseInt(h.sourceMark)}f.answerStatus="incorrect";if(p&&p.length>0&&d&&d.length>1){var l=0;var c=p.length;for(var m=1;m<d.length;m++){if(d[m]!=-1&&d[m]==p[m-1]){l++}}if(l==c){f.right=true;f.answerStatus="correct"}else{f.answerStatus="incorrect"}var o=h.blankNum.split("*^*");if(o.length>1){if(l>=c-1){f.userMark=2}else{if(l==c-2){f.userMark=1}}}else{if(l==c){f.userMark=f.mark}else{if(l>=Math.ceil(c/2)){f.userMark=f.mark/2}}}}}else{if(h.className=="org.neworiental.rmp.base::BaseInputText"){s=true;f.rightAns="";f.userAns="";var d=null;if(e){d=Player.getSubjectAnswer(e,b,h)}if(d&&d.length>1){f.userAns=d[1]}if(f.userAns!=""){f.answerStatus="Answered"}else{f.answerStatus="Not Answered"}}else{if(h.className=="org.neworiental.rmp.base::TOEFLRecord"){s=true;f.rightAns="";f.userAns="";f.answerStatus="Answered"}else{if(h.className=="org.neworiental.rmp.base::TOEFLTable"){s=true;var p=JSON.parse(h.rightAns);var d=null;if(e){d=Player.getSubjectAnswer(e,b,h)}if(p&&p.length>0){for(var n=0;n<p.length;n++){if(n!=0){f.rightAns+=","}var a=p[n];f.rightAns+=""+(a+1)}}if(d&&d.length>1){for(var m=1;m<d.length;m++){if(d[m]!=-1){if(f.userAns!=""){f.userAns+=","}var a=d[m];if(a<0){f.userAns+="没选"}else{f.userAns+=""+(a+1)}}}}var q=false;if(p&&p.length>0&&d&&d.length>1){for(var m=1;m<d.length;m++){if(d[m]==-1||d[m]!=p[m-1]){q=false;break}}}f.right=q;if(h.sourceMark){f.mark=parseInt(h.sourceMark);if(q){f.userMark=f.mark}}if(q){f.answerStatus="correct"}else{f.answerStatus="incorrect"}}}}}}}}}}}}if(s){return f}else{return null}},showTestReview:function(){var c=[];var d=Player.parts[Player.partIndex];var h=Player.answers[Player.itemIndex];var m=Player.getPageAnswer(Player.subjectList,Player.pageIndex);h[Player.pageIndex]=m;for(var b=0;b<d.items.length;b++){var l=d.items[b];var j=Player.answers[b];var e=l.subjectList;for(var g=0;g<e.pages.length;g++){var i=e.pages[g];var f=j[g];var k=this.getPageSubjectInfo(i,f);if(k!=null){var a={itemIndex:b,pageIndex:g,des:k.des,userAns:k.userAns};if(b>Player.partStatus.itemIndex||(b==Player.partStatus.itemIndex&&g>Player.partStatus.pageIndex)){a.status="No Seen"}else{if(a.userAns){a.status="Answered"}else{a.status="Not Answered"}}c.push(a)}}}this.buildTestList(c);this.show()},buildTestList:function(b){var e=$("#review_content").empty();var c=$("<ul class='review_grid'></ul>").appendTo(e);c.append("<li class='hd'><div class='review_no'>NO.</div><div class='review_des' style='width: 50%'>Description</div><div class='review_uanswer' style='width: 25%'>Your Answer</div><div class='review_canswer'>Status</div></li>");for(var a=0;a<b.length;a++){var d=b[a];var f=$("<li class='item'><div class='review_no'>"+(a+1)+"</div><div class='review_des' style='width: 50%'>"+d.des+"</div><div class='review_uanswer' style='width: 25%'>"+d.userAns+"</div><div class='review_canswer'>"+d.status+"</div></li>");f.appendTo(c);if(a%2!=0){f.addClass("dif")}f.attr({itemIndex:d.itemIndex,pageIndex:d.pageIndex});if(d.status!="No Seen"){f.bind("click",function(){$("#review_content").find(".review_selected").removeClass("review_selected");$(this).addClass("review_selected");Player.itemIndex=parseInt($(this).attr("itemIndex"));Player.pageIndex=parseInt($(this).attr("pageIndex"));Player.play()})}}}};function onlyNum(b){var a=b||window.event;if(!(a.keyCode>=8&&a.keyCode<=20)||(a.keyCode>=33&&a.keyCode<=46)){if(!((a.keyCode>=48&&a.keyCode<=57)||(a.keyCode>=96&&a.keyCode<=105))){if(window.event){a.returnValue=false}else{a.preventDefault()}}}return a.keyCode};