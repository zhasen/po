var TESTING_CALLBACK_METHOD={loadData:"loadData",getPageNumber:"getPageNumber",sendAnswer:"sendAnswer"};var testing_callback;var testingDes;$(function(){testingDes=new Designer({target:$("#subject_designer"),status:"testing",imgPath:"http://116.213.70.92/files_test/oms/data/online/resource/",audioPath:"http://116.213.70.92/oms2/online/downloadFile!doDownload.do?keyUUID=",audioImgPath:"http://116.213.70.92/files_test/oms/data/online/resource/0dc00d23-e8c8-436c-af49-f04b45dd368d/201412/04/",statusType:paperConfig.statusType});Testing.init()});var Testing={init:function(){$(window).bind("resize",function(){Testing.resizeView()});Testing.resizeView();Testing.loadPaper()},paper:null,testId:"",testResult:null,resizeView:function(){var a=$(window).height();var b=a-125;testingDes.config.pageHeight=b;$("#subject_designer").height(a);$("#subject_designer").find(".subject_page").height(b);$("#subject_designer").find(".designer_canvas").css("min-height",a-146)},loadPaper:function(){var b=$(".designer_loading");b.css({top:($(window).height()-b.outerHeight())/2,left:($(window).width()-b.outerWidth())/2});$.ajax({url:"test-get",type:"post",data:{method:"getPaperAllDataByPaperId",paperId:paperConfig.paperId,testId:paperConfig.testId,userId:paperConfig.userId,allotId:paperConfig.allotId,classCode:paperConfig.classCode,testFrom:paperConfig.testFrom},dataType:"json",success:function(d){if(d.errno){alert("数据加载失败！");if(testing_callback){var c={};c.method=TESTING_CALLBACK_METHOD.loadData;c.data=0;testing_callback(c)}}else{a(d);if(testing_callback){var c={};c.method=TESTING_CALLBACK_METHOD.loadData;c.data=1;testing_callback(c)}}},error:function(){if(defaultDef){a(defaultDef)}else{alert("数据加载失败！");if(testing_callback){var c={};c.method=TESTING_CALLBACK_METHOD.loadData;c.data=0;testing_callback(c)}}}});function a(c){Testing.paper=c.result;Testing.testId=Testing.paper.testId;if(Testing.paper.allTestResultDetail&&Testing.paper.allTestResultDetail.length>0){Testing.testResult=Testing.paper.allTestResultDetail}$("#paper_name").text(Testing.paper.paperName);Player.structItem=Testing.paper.structItem.trees;b.remove();$(".designer_box").show();Player.init();console.log("开始测试，testId："+Testing.testId);if(testingDes.config.statusType=="review"){Review.init()}}}};var Player={init:function(){$("#btn_back").bind("click",function(){Player.back()});$("#btn_next").bind("click",function(){Player.next()});$("#btn_continue").bind("click",function(){Player.next()});$("#btn_ok").bind("click",function(){$("#btn_next").prop("disabled","")});$("#btn_timer").bind("click",function(){if($("#header_timer").is(":visible")){$("#header_timer").hide();$("#btn_timer").val("showTime")}else{$("#header_timer").show();$("#btn_timer").val("hideTime")}});$("#btn_review").bind("click",function(){Review.show()});this.buildItems();var b=null;if(Testing.testResult){var d={};for(var h=0;h<Testing.testResult.length;h++){var l=Testing.testResult[h];Player.paperAnswers[l.subjectId]=JSON.parse(l.answerContent);Player.paperDatas[l.subjectId]=JSON.parse(l.subjectData);if(l.subjectExtend){d[l.subjectId]=JSON.parse(l.subjectExtend)}}if(testingDes.config.statusType=="normal"){for(var h=this.parts.length-1;h>=0;h--){var f=this.parts[h];var j=false;for(var c=f.items.length-1;c>=0;c--){var k=f.items[c];var a=JSON.parse(decodeURIComponent(k.item.subjectData)).id;if(d[a]){j=true;var e=d[a];this.partIndex=e.partIndex;this.itemIndex=e.itemIndex;this.pageIndex=e.pageIndex;var g=Player.paperDatas[a];if(g.times&&g.times.length>0){b=g.times[0]}break}}if(j){break}}}}this.buildAnswer();Player.play(b)},structItem:null,parts:[],partIndex:0,partStatus:{itemIndex:0,pageIndex:0},items:[],itemIndex:0,subjectList:null,pageIndex:0,paperAnswers:{},paperDatas:{},answers:[],pageAnswer:[],play:function(A){if(this.itemIndex>this.partStatus.itemIndex){this.partStatus.itemIndex=this.itemIndex;this.partStatus.pageIndex=0}else{if(this.itemIndex==this.partStatus.itemIndex){if(this.pageIndex>this.partStatus.pageIndex){this.partStatus.pageIndex=this.pageIndex}}}var r=this.parts[this.partIndex];this.items=r.items;var y=this.items[this.itemIndex];$("#part_name").text("[ "+r.displayName+" ]");var w=y.item.subjectData;w=decodeURIComponent(w);this.subjectList=JSON.parse(w);var e=this.subjectList.pages[this.pageIndex];var t=this.answers[this.itemIndex];this.pageAnswer=t[this.pageIndex];testingDes.open(e);Testing.resizeView();if(e.url){$("#bgaudio_player").attr("src",testingDes.config.audioPath+e.url)}else{$("#bgaudio_player").attr("src","")}$("#header_right_normal").find(".testbtn").hide();if(e.extralData){$("#btn_extral").show().unbind().bind("click",function(){testingDes.open(e.extralData);Testing.resizeView();$(".designer_header_right").hide();$("#header_right_extral_return").show()});$("#btn_extral_return").unbind().bind("click",function(){testingDes.open(e);Testing.resizeView();$(".designer_header_right").hide();$("#header_right_normal").show()})}else{$("#btn_extral").hide()}$(".designer_header_right").hide();$("#header_right_normal").show();$("#btn_next").val("next");if(testingDes.config.statusType=="review"){$("#btn_next").show();$("#btn_back").show();$("#btn_review").show();var q=this.getBack();if(q==null){$("#btn_back").prop("disabled","disabled")}else{$("#btn_back").prop("disabled","")}var o=this.getNext();if(o==null){$("#btn_next").prop("disabled","disabled")}else{$("#btn_next").prop("disabled","")}}else{if(e.slidingType=="normal_mode"){if(e.isExplain=="true"){$("#btn_continue").show().prop("disabled","")}else{$("#btn_next").show();$("#btn_back").show();var q=this.getBack();if(q==null){$("#btn_back").prop("disabled","disabled")}else{$("#btn_back").prop("disabled","")}var o=this.getNext();if(o==null){$("#btn_next").val("submit")}}}else{if(e.slidingType=="complete_mode"){$("#btn_continue").show().prop("disabled","disabled");if(e.isExplain=="true"){var x=0;for(var z=0;z<e.containers.length;z++){var l=e.containers[z];if(l.contents){for(var u=0;u<l.contents.length;u++){var j=l.contents[u];if(j.className=="org.neworiental.rmp.base::BaseTLFText"){x++}}}}if(x==1){$(".subject_page").bind("scroll",function(){var i=$(this).scrollTop();$(this).scrollTop(999999);if(i==$(this).scrollTop()){$("#btn_continue").prop("disabled","")}$(this).scrollTop(i)})}}}else{if(e.slidingType=="auto_mode"){$("#btn_continue").show().prop("disabled","");var v=$(".subject_box[n='org.neworiental.rmp.base::ToelfAudio']");if(v.length>0){var s=v.find("audio");s.bind("ended",function(){Player.next()})}var B=$(".subject_box[n='org.neworiental.rmp.base::TOEFLTimerViewer']");if(B.length>0){var k=B.find(".subject_canvas");k.bind("ended",function(){Player.next()})}var b=$(".subject_box[n='org.neworiental.rmp.base::TOEFLRecord']");if(b.length>0){var a=b.find(".subject_canvas");a.bind("ended",function(){Player.next()})}}else{if(e.slidingType=="custom_mode"){$("#btn_next").show().prop("disabled","disabled");$("#btn_ok").show().prop("disabled","disabled");var c=$(".subject_box[n='org.neworiental.rmp.base::OptionGroup']");if(c.length>0){c.find("input").bind("click",function(){$("#btn_ok").prop("disabled","")})}}}}}}if(y.item.subjectType=="TOEFL_READ"){var n=[];for(var d=0;d<this.subjectList.pages.length;d++){var m=this.subjectList.pages[d];if(m.isExplain=="false"){n.push(d)}}if(e.isExplain=="true"){$("#header_question").hide()}else{$("#header_question").show();var h=n.indexOf(this.pageIndex)+1;$("#header_question").children("span").text(h+" of "+n.length)}}else{$("#header_question").show();$("#header_question").children("span").text((this.itemIndex+1)+" of "+r.items.length)}if(testingDes.config.statusType!="review"){var g=r.relation;if(g&&g.examTime){if(this.timer==null||this.timer.relation.id!=g.id){this.stopTimer();var f=g.examTime*60;if(typeof A!="undefined"&&A!=null){f=A}this.initTimer(g,f)}}else{this.stopTimer()}if(this.timer!=null){if(e.isExplain=="true"){this.pauseTimer()}else{this.activeTimer()}}}},getNext:function(){var k={partIndex:this.partIndex,itemIndex:this.itemIndex,pageIndex:this.pageIndex};if(testingDes.config.statusType=="review"){if(this.pageIndex<this.subjectList.pages.length-1){k.pageIndex++}else{if(this.itemIndex<this.items.length-1){k.itemIndex++;k.pageIndex=0}else{k=null}}}else{if(this.itemIndex<this.partStatus.itemIndex||this.pageIndex<this.partStatus.pageIndex){var b=this.parts[this.partIndex];for(var e=this.itemIndex;e<=this.partStatus.itemIndex;e++){var h=b.items[e];var a=h.item.subjectData;a=decodeURIComponent(a);var c=JSON.parse(a);var g=this.pageIndex+1;if(e!=this.itemIndex){g=0}for(var d=g;d<c.pages.length;d++){var f=c.pages[d];if(f.isExplain=="false"){k.itemIndex=e;k.pageIndex=d;return k}}}}else{if(this.pageIndex<this.subjectList.pages.length-1){k.pageIndex++}else{if(this.itemIndex<this.items.length-1){k.itemIndex++;k.pageIndex=0}else{if(this.partIndex<this.parts.length-1){k.partIndex++;k.itemIndex=0;k.pageIndex=0}else{k=null}}}}}return k},next:function(){if(testing_callback){var a={};a.method=TESTING_CALLBACK_METHOD.getPageNumber;a.currentPage=this.pageIndex;a.orientation="next";var d=testing_callback(a);if(typeof(d)!="undefined"){if(paperConfig.statusType=="normal"){var b=this.getNext();this.sendAnswer(b)}if(d==-1){if(paperConfig.statusType=="normal"){alert("完成答卷，等待老师讲解")}}else{if(d!=this.pageIndex){this.pageIndex=d;this.play()}}return}}var b=this.getNext();if(b==null){if(confirm("确认提交试卷？")){this.submit()}}else{var e=false;var c=true;if(b.partIndex!=this.partIndex){c=confirm("确定要进入下一部分？");if(c){this.partStatus={itemIndex:0,pageIndex:0};e=true}}if(c){if(testingDes.config.statusType!="review"){this.sendAnswer(b)}this.partIndex=b.partIndex;this.itemIndex=b.itemIndex;this.pageIndex=b.pageIndex;this.play()}if(e){this.buildAnswer()}}},getBack:function(){if(testingDes.config.statusType=="review"){var k={pageIndex:this.pageIndex,itemIndex:this.itemIndex};if(this.pageIndex>0){k.pageIndex--}else{if(this.itemIndex>0){k.itemIndex--;k.pageIndex=0}else{k=null}}return k}else{var b=this.parts[this.partIndex];for(var e=this.itemIndex;e>=0;e--){var h=b.items[e];var a=h.item.subjectData;a=decodeURIComponent(a);var c=JSON.parse(a);var g=this.pageIndex-1;if(e!=this.itemIndex){g=c.pages.length-1}for(var d=g;d>=0;d--){var f=c.pages[d];if(f.isExplain=="false"){return{itemIndex:e,pageIndex:d}}}}}return null},back:function(){if(testing_callback){var a={};a.method=TESTING_CALLBACK_METHOD.getPageNumber;a.currentPage=this.pageIndex;a.orientation="back";var c=testing_callback(a);if(typeof(c)!="undefined"){if(c==-1){}else{if(c!=this.pageIndex){this.pageIndex=c;this.play()}}return}}var b=this.getBack();if(b!=null){if(testingDes.config.statusType!="review"){this.sendAnswer({partIndex:this.partIndex,itemIndex:b.itemIndex,pageIndex:b.pageIndex})}this.itemIndex=b.itemIndex;this.pageIndex=b.pageIndex;this.play()}},buildAnswer:function(){this.answers=[];var c=this.parts[this.partIndex];for(var h=0;h<c.items.length;h++){var l=c.items[h];var a=JSON.parse(decodeURIComponent(l.item.subjectData)).id;if(this.paperAnswers[a]){this.answers.push(this.paperAnswers[a])}else{var b=l.item.subjectData;b=decodeURIComponent(b);var e=JSON.parse(b);var d=e.pages;var f=[];for(var j=0;j<d.length;j++){var k=d[j];var g=this.getPageAnswer(e,j);f.push(g)}this.answers.push(f)}}},sendAnswer:function(j){var b=this.itemIndex;var e=this.pageIndex;var k=this.items[b];var h=this.answers[this.itemIndex];var i=this.getPageAnswer(this.subjectList,this.pageIndex);h[this.pageIndex]=i;var d=JSON.stringify(h);this.paperAnswers[this.subjectList.id]=h;var c=this.buildSubjectData(h);var a=c.data.totalMark;var f=JSON.stringify(c);this.paperDatas[this.subjectList.id]=c;var g={testId:Testing.testId,testFrom:"tpo",subjectId:this.subjectList.id,subjectIndex:b,subjectData:f,examPoint:"",answerContent:d,pageIndex:e,leftTimes:"[]",isSubmit:0,extend:"",subjectExtend:JSON.stringify(j),subjectMark:a,usedTime:0};$.ajax({url:"test-save",type:"post",data:{method:"saveTestResultDetail",data:g}});if(testing_callback){var l={};l.method=TESTING_CALLBACK_METHOD.sendAnswer;l.data=g;testing_callback(l)}},getPageAnswer:function(e,d){var l=e.pages[d];var j=[];for(var r=0;r<l.containers.length;r++){var a=l.containers[r];if(a.contents&&a.contents.length>0){for(var m=0;m<a.contents.length;m++){var q=a.contents[m];if(q.className=="org.neworiental.rmp.base::OptionGroup"){var c=[q.className];var k=$("#"+q.ID);if(k.length>0){k.find("input[name=subject_select_radio]:checked").each(function(){var i=parseInt($(this).attr("ind"));c.push(i)})}j.push(c)}else{if(q.className=="org.neworiental.rmp.base::ToelfInsertPart"){var c=[q.className];var o=-1;var k=$("#"+q.ID);if(k.length>0){var g=k.find(".inserted");if(g.length>0){o=parseInt(g.attr("ind"))}}c.push(o);j.push(c)}else{if(q.className=="org.neworiental.rmp.base::TOEFLReadingDrag"){var c=[q.className];if(q.answer){c=c.concat(q.answer)}else{var b=q.blankNum.split("*^*");for(var h=0;h<b.length;h++){var n=parseInt(b[h]);var f=0;while(f<n){c.push(-1);f++}}}j.push(c)}else{if(q.className=="org.neworiental.rmp.base::TOEFLRecord"){var c=[q.className,""];j.push(c)}else{if(q.className=="org.neworiental.rmp.base::BaseInputText"){var c=[q.className];var o="";var k=$("#"+q.ID);if(k.length>0){var p=k.find("textarea");o=p.val()}c.push(o);j.push(c)}}}}}}}}return j},buildSubjectData:function(f){var j={gradeInfo:"[]",maxIndex:0,index:0,id:this.subjectList.id,times:[]};var c=this.subjectList.pages;for(var e=0;e<=this.pageIndex;e++){var h=c[e];if(h.isExplain=="false"){j.index++}}j.maxIndex=this.pageIndex+1;if(j.maxIndex>c.length-1){j.maxIndex=c.length-1}if(this.timer!=null){j.times=[this.timer.time]}var d={id:this.subjectList.id,testPoint:null,subjectMark:0,totalMark:0,answerContent:f};j.data=d;var b=[];d.data=b;for(var e=0;e<c.length;e++){var h=c[e];var g=f[e];var a=this.getPageData(h,d,g);b.push(a)}return j},getPageData:function(k,f,g){var b={ID:k.ID,data:[]};if(k.isExplain=="true"){return b}for(var q=0;q<k.containers.length;q++){var a=k.containers[q];if(a.contents&&a.contents.length>0){for(var l=0;l<a.contents.length;l++){var p=a.contents[l];if(p.className=="org.neworiental.rmp.base::OptionGroup"){var j=this.getSubjectAnswer(g,k,p);var o={ID:p.ID,optionCount:p.options.length,isResponse:true,type:p.className,data:"",subjectiveItem:p.subjectiveItem=="false"?false:true,testPointID:[p.testPointID],testPointName:[p.testPointName],rightAnswer:JSON.parse(p.rightAns),userAnswer:j,userMark:[0],sourceMark:[parseInt(p.sourceMark)]};if(j.length<=1){o.isResponse=false}else{var m=true;if(j.length-1!=o.rightAnswer.length){m=false}else{for(var e=1;e<j.length;e++){if(j[e]!=o.rightAnswer[e-1]){m=false;break}}}if(m){o.userMark=o.sourceMark}}b.data.push(o);var n=parseInt(p.sourceMark);if(n){f.totalMark+=n}}else{if(p.className=="org.neworiental.rmp.base::ToelfInsertPart"){var j=this.getSubjectAnswer(g,k,p);var o={ID:p.ID,isResponse:true,type:p.className,data:"",subjectiveItem:p.subjectiveItem=="false"?false:true,testPointID:[p.testPointID],testPointName:[p.testPointName],rightAnswer:JSON.parse(p.rightAns),userAnswer:j,userMark:[0],sourceMark:[parseInt(p.sourceMark)]};if(j.length<=1||j[1]==-1){o.isResponse=false}else{if(o.rightAnswer.length>0){if(j[1]==o.rightAnswer[0]){o.userMark=o.sourceMark}}}b.data.push(o);var n=parseInt(p.sourceMark);if(n){f.totalMark+=n}}else{if(p.className=="org.neworiental.rmp.base::TOEFLReadingDrag"){var j=this.getSubjectAnswer(g,k,p);var o={ID:p.ID,isResponse:false,type:p.className,data:"",subjectiveItem:p.subjectiveItem=="false"?false:true,testPointID:[p.testPointID],testPointName:[p.testPointName],rightAnswer:JSON.parse(p.rightAns),userAnswer:j,userMark:[0],sourceMark:[parseInt(p.sourceMark)]};for(var e=1;e<j.length;e++){if(j[e]!=-1){o.isResponse=true;break}}if(o.isResponse){var d=0;var h=o.rightAnswer.length;for(var e=1;e<j.length;e++){if(j[e]!=-1&&j[e]==o.rightAnswer[e-1]){d++}}var c=p.blankNum.split("*^*");if(c.length>1){if(d>=h-1){o.userMark=[2]}else{if(d==h-2){o.userMark=[1]}}}else{if(d==h){o.userMark=o.sourceMark}else{if(d>=Math.ceil(h/2)){o.userMark=[parseInt(p.sourceMark)/2]}}}}b.data.push(o);var n=parseInt(p.sourceMark);if(n){f.totalMark+=n}}else{if(p.className=="org.neworiental.rmp.base::BaseInputText"){var j=this.getSubjectAnswer(g,k,p);var o={ID:p.ID,isResponse:false,type:p.className,data:"",subjectiveItem:p.subjectiveItem=="false"?false:true,testPointID:[p.testPointID],testPointName:[p.testPointName],rightAnswer:JSON.parse(p.rightAns),userAnswer:j,userMark:[0],sourceMark:[parseInt(p.sourceMark)]};if(j[1]!=""){o.isResponse=true}b.data.push(o);var n=parseInt(p.sourceMark);if(n){f.totalMark+=n}}else{if(p.className=="org.neworiental.rmp.base::TOEFLRecord"){var j=this.getSubjectAnswer(g,k,p);var o={ID:p.ID,isResponse:true,type:p.className,data:"",subjectiveItem:p.subjectiveItem=="false"?false:true,testPointID:[p.testPointID],testPointName:[p.testPointName],rightAnswer:JSON.parse(p.rightAns),userAnswer:j,userMark:[0],sourceMark:[parseInt(p.sourceMark)]};b.data.push(o);var n=parseInt(p.sourceMark);if(n){f.totalMark+=n}}}}}}}}}return b},getSubjectAnswer:function(d,g,h){var e=[];for(var c=0;c<d.length;c++){var b=d[c];if(b[0]==h.className){e.push(b)}}var j=-1;for(var l=0;l<g.containers.length;l++){var a=g.containers[l];if(a.contents&&a.contents.length>0){for(var f=0;f<a.contents.length;f++){var k=a.contents[f];if(k.className==h.className){j++}if(k.ID==h.ID){return e[j]}}}}return null},submit:function(){var g={testId:Testing.testId,testFrom:"tpo",subjectIndex:0,pageIndex:0,leftTimes:"[]",isSubmit:1,totalMark:0,totalUseTime:0,extend:"",subjects:[]};var d=this.answers[this.itemIndex];var c=this.getPageAnswer(this.subjectList,this.pageIndex);d[this.pageIndex]=c;this.paperAnswers[this.subjectList.id]=d;var e=this.buildSubjectData(d);this.paperDatas[this.subjectList.id]=e;for(var f in this.paperAnswers){var b=this.paperAnswers[f];var e=this.paperDatas[f];var a={subjectId:f,subjectData:JSON.stringify(e),answerContent:JSON.stringify(b),subjectMark:e.data.totalMark,examPoint:null,usedTime:0,subjectExtend:""};g.subjects.push(a)}$.ajax({url:"test-save",type:"post",data:{method:"finishTest",data:g},success:function(){alert("提交成功!");$("#header_right_normal").find("input").unbind()}})},timer:null,initTimer:function(a,b){$("#header_timer").show();$("#btn_timer").val("hideTime");this.timer={};this.timer.relation=a;this.timer.time=b;this.timer.interval=null},activeTimer:function(){var a=new Date().getTime();if(this.timer.interval!=null){return}function b(){var j=Player.timer.time;var c=Math.floor(j/3600);if(c<10){c="0"+c}var f=Math.floor((j-c*3600)/60);if(f<10){f="0"+f}var k=j%60;if(k<10){k="0"+k}if(j<=0){clearInterval(Player.timer.interval);alert("倒计时已到！");var d=Player.parts[Player.partIndex];for(var e=Player.itemIndex;e<d.items.length;e++){if(Player.itemIndex!=e){Player.pageIndex=0}Player.itemIndex=e;var h=Player.items[Player.itemIndex];var g=h.item.subjectData;g=decodeURIComponent(g);Player.subjectList=JSON.parse(g);Player.sendAnswer({partIndex:Player.partIndex+1,itemIndex:0,pageIndex:0})}Player.partIndex++;Player.itemIndex=0;Player.pageIndex=0;Player.play()}$("#header_timer").text(c+" : "+f+" : "+k)}this.timer.interval=setInterval(function(){var c=new Date().getTime();var d=c-a;var e=Math.floor(d/1000);if(e==0){return}a=c;Player.timer.time-=e;b()},250);b();$("#header_timer_box").show()},pauseTimer:function(){if(this.timer!=null){clearInterval(this.timer.interval);this.timer.interval=null}$("#header_timer_box").hide()},stopTimer:function(){this.pauseTimer();this.timer=null},buildItems:function(){function c(g,e){if(g.items&&g.items.length>0){var f;if(g.relation){f=g.relation}else{if(e&&e.relation){f=e.relation}}if(f){g.relation=f}if(e){g.displayName=e.name+"/"+g.name}else{g.displayName=g.name}Player.parts.push(g)}else{if(g.trees&&g.trees.length>0){for(var d=0;d<g.trees.length;d++){var h=g.trees[d];c(h,g)}}}}this.parts=[];for(var b=0;b<this.structItem.length;b++){var a=this.structItem[b];c(a)}}};var Review={init:function(){var n=[];for(var i=0;i<Player.parts.length;i++){var d=Player.parts[i];var j={displayName:d.displayName,name:d.name,correctCount:0,subjectCount:0,userMark:0,totalMark:0,subjects:[]};for(var b=0;b<d.items.length;b++){var m=d.items[b];var c=m.item.subjectData;c=decodeURIComponent(c);var e=JSON.parse(c);var f=Player.paperAnswers[e.id];for(var h=0;h<e.pages.length;h++){var k=e.pages[h];var g=null;if(f&&f[h]){g=f[h]}var l=this.getPageSubjectInfo(k,g);if(l!=null){var a={partIndex:i,itemIndex:b,pageIndex:h,des:l.des,rightAns:l.rightAns,userAns:l.userAns};j.subjectCount++;j.totalMark+=l.mark;j.userMark+=l.userMark;j.subjects.push(a);if(l.right){j.correctCount++}}}}n.push(j)}this.buildList(n);this.show()},buildList:function(b){var g=$("#review_content");for(var e=0;e<b.length;e++){var a=b[e];g.append("<div class='review_title'>"+a.displayName+"</div>");if(a.name!="Speaking"&&a.name!="Writing"){g.append("<div class='review_statis'>正确数/题目数：<span>"+a.correctCount+" / "+a.subjectCount+"</span>得分/总分：<span>"+a.userMark+" / "+a.totalMark+"</span></div>")}var d=$("<ul class='review_grid'></ul>").appendTo(g);d.append("<li class='hd'><div class='review_no'>NO.</div><div class='review_des'>Description</div><div class='review_uanswer'>Your Answer</div><div class='review_canswer'>Correct Answer</div><div class='review_correct'></div></li>");for(var c=0;c<a.subjects.length;c++){var f=a.subjects[c];var h=$("<li class='item'><div class='review_no'>"+(c+1)+"</div><div class='review_des'>"+f.des+"</div><div class='review_uanswer'>"+f.userAns+"</div><div class='review_canswer'>"+f.rightAns+"</div><div class='review_correct'><span class='tpbtn'>未批改</span></div></li>");h.appendTo(d);if(c%2!=0){h.addClass("dif")}h.attr({partIndex:f.partIndex,itemIndex:f.itemIndex,pageIndex:f.pageIndex});h.bind("click",function(){$("#review_content").find(".review_selected").removeClass("review_selected");$(this).addClass("review_selected");var i=Player.partIndex;Player.partIndex=parseInt($(this).attr("partIndex"));Player.itemIndex=parseInt($(this).attr("itemIndex"));Player.pageIndex=parseInt($(this).attr("pageIndex"));if(Player.partIndex!=i){Player.buildAnswer()}Player.play()})}}},show:function(){if(testing_callback){}else{$("#dlg_paper_review").dlg()}},getPageSubjectInfo:function(b,e){var s=false;var f={des:"",mark:0,rightAns:"",userAns:"",userMark:0,right:false};for(var g=0;g<b.containers.length;g++){var j=b.containers[g];if(j.contents&&j.contents.length>0){for(var r=0;r<j.contents.length;r++){var h=j.contents[r];if(h.className=="org.neworiental.rmp.base::BaseRichTxt"){f.des+=testingDes.utils.toText(h.htmlText)+"&nbsp;&nbsp;"}else{if(h.className=="org.neworiental.rmp.base::BaseTLFText"){f.des+=testingDes.utils.toText(decodeURIComponent(h.text))+"&nbsp;&nbsp;"}else{if(h.className=="org.neworiental.rmp.base::OptionGroup"){s=true;var p=JSON.parse(h.rightAns);var d=null;if(e){d=Player.getSubjectAnswer(e,b,h)}var k=["A","B","C","D","E","F"];if(p&&p.length>0){for(var n=0;n<p.length;n++){if(n!=0){f.rightAns+=","}var a=p[n];f.rightAns+=k[a]}}if(d&&d.length>1){for(var n=1;n<d.length;n++){if(n!=1){f.userAns+=","}var a=d[n];f.userAns+=k[a]}}var q=false;if(p&&d&&d.length>1){if(d.length-1==p.length){q=true;for(var m=1;m<d.length;m++){if(d[m]!=p[m-1]){q=false;break}}}}f.right=q;if(h.sourceMark){f.mark=parseInt(h.sourceMark);if(q){f.userMark=f.mark}}}else{if(h.className=="org.neworiental.rmp.base::ToelfInsertPart"){s=true;var p=JSON.parse(h.rightAns);var d=null;if(e){d=Player.getSubjectAnswer(e,b,h)}if(p&&p.length>0){f.rightAns="第"+(p[0]+1)+"空"}if(d&&d.length>1&&d[1]!=-1){f.userAns="第"+(d[1]+1)+"空"}var q=false;if(p&&p.length>0&&d&&d.length>1){if(d[1]!=-1&&d[1]==p[0]){q=true}}f.right=q;if(h.sourceMark){f.mark=parseInt(h.sourceMark);if(q){f.userMark=f.mark}}}else{if(h.className=="org.neworiental.rmp.base::TOEFLReadingDrag"){s=true;var p=JSON.parse(h.rightAns);var d=null;if(e){d=Player.getSubjectAnswer(e,b,h)}if(p&&p.length>0){for(var n=0;n<p.length;n++){if(n!=0){f.rightAns+=","}var a=p[n];f.rightAns+="第"+(a+1)+"空"}}if(d&&d.length>1){for(var m=1;m<d.length;m++){if(d[m]!=-1){if(f.userAns!=""){f.userAns+=","}var a=d[m];f.userAns+="第"+(a+1)+"空"}}}if(h.sourceMark){f.mark=parseInt(h.sourceMark)}if(p&&p.length>0&&d&&d.length>1){var l=0;var c=p.length;for(var m=1;m<d.length;m++){if(d[m]!=-1&&d[m]==p[m-1]){l++}}if(l==c){f.right=true}var o=h.blankNum.split("*^*");if(o.length>1){if(l>=c-1){f.userMark=2}else{if(l==c-2){f.userMark=1}}}else{if(l==c){f.userMark=f.mark}else{if(l>=Math.ceil(c/2)){f.userMark=[parseInt(f.mark)/2]}}}}}else{if(h.className=="org.neworiental.rmp.base::BaseInputText"){s=true;f.rightAns="---";f.userAns="---";var d=null;if(e){d=Player.getSubjectAnswer(e,b,h)}if(d&&d.length>1){f.userAns=d[1]}}else{if(h.className=="org.neworiental.rmp.base::TOEFLRecord"){s=true;f.rightAns="---";f.userAns="---"}}}}}}}}}}if(s){return f}else{return null}}};function onlyNum(b){var a=b||window.event;if(!(a.keyCode>=8&&a.keyCode<=20)||(a.keyCode>=33&&a.keyCode<=46)){if(!((a.keyCode>=48&&a.keyCode<=57)||(a.keyCode>=96&&a.keyCode<=105))){if(window.event){a.returnValue=false}else{a.preventDefault()}}}return a.keyCode};